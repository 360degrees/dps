
Записки по разработке
====================


Синхронная репликация каждого сообщения оказалась ужасно медленной.
Пришлось выносить её в отдельный процесс, который ждет по 50 мс и отсылает сообщения пачкой.



На бенчмарке (1000 клиентов, 1-2 канала подписки, шлют сообщения 1 RPS, очередь глубиной 100) всплыло:
на одном сервере CPU 20-140% на Amazon Large Instance.
При включении репликации всё отваливается по таймауту.


Вставили в publish проверку: при таймауте на публикацию в канал проверяем очередь сообщений.
После вставки этой отладки выяснилось, что канал блокируется при длине очереди сообщений чуть более 150.
Из них:
65 unsubscribe
67 subscribe
23 publish

Делаем вывод, что канал занимается только тем, что подписывает и отписывает временных клиентов.


!! Надо указывать внутри модуля не messages_limit(), а ?MODULE:messages_limit(), что бы можно было meck-ать.



Зафискированные проблемы (без понимания их фатальности)

1. Пришедший long-poll клиент шлет 2*N сообщений на subscribe/unsubscribe. Как следствие,
одно пришедшее ему сообщение порождает целую кучу остальных
2. Тест на посылку 2000 сообщений проваливается когда длина очереди 1000, но проходит когда 100
Залипание происходит при пустой очереди сообщений у канала, таймаута в 500 мс не хватает на отработку
publish. Коммит 562a06e9a9e



Как выяснилось, тест не проходил из-за meck. Как только для теста был выключен meck, тормоза пропали.
